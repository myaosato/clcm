(defpackage :clcm/inlines/emphasis
  (:use :cl
        :clcm/utils
        :clcm/characters
        :clcm/inlines/parser)
  (:export :scan-emphasis
           :process-emphasis))
(in-package :clcm/inlines/emphasis)

(defun scan-emphasis (parser)
  (let ((type (get-type parser)))
    (when type
      (let* ((delimiter-run (get-delimiter-run type parser))
             (len (length delimiter-run))
             (close nil)
             (open nil))
        (setf open (can-open type parser))
        (setf close (can-close type parser))
        (when (or open close)
          (push-op parser (make-delimiter :type type 
                                          :start (fill-pointer (ip-queue parser))
                                          :num len
                                          :open open
                                          :close close))
          (push-string parser delimiter-run)
          (pos+ parser len))))))

;; type
(defun get-type (parser)
  (cond ((scan parser "^\\*") :*)
        ((scan parser "^_") :_)
        (t nil)))

;; delimiter-run
(defun get-delimiter-run-length (type parser)
  (length (get-delimiter-run type parser)))

(defun get-delimiter-run (type parser)
  (let ((char (case type (:* #\*) (:_ #\_))))
    (format nil "窿祜镳烘矧烘蝻烘矧航疱咫疳蝮弪瞟瑚栝戾ㄡ钿ㄣ栳蚪汨狎┅恒镬戾泗汨狎┅┅换汜瞽镳孱ㄤ彐躅汜瞽镳孱豉疱疳蝮弪ㄣ狍豉疱êí汜瞽镳孱疳蝮弪┅êㄟ汜瞽镳孱疳蝮弪┅┅ㄤ彐躅汜瞽镳孱疳蝮弪ㄩ蟓戾骠骒犷腴铉溴扉黹翦颦蝓邯疳蝮弪┅ㄤ彐躅攮汜瞽镳孱疳蝮弪ㄡ钿ㄩ蟓戾骠骒犷腴铉溴扉黹翦颦蝓哼疳蝮弪矧铒ㄩ蟓蜷玷舡骒犷腴铉溴扉黹翦颦蝓哼疳蝮弪┅ㄩ蟓蜷玷舡骒犷腴铉溴扉黹翦颦蝓哼疳蝮弪吼蝈沐溴洵怡瘐钽趱狒轱舂┅换汜瞽沆矬ㄤ彐躅汜瞽沆矬豉疱疳蝮弪ㄣ狍豉疱êí汜瞽沆矬疳蝮弪┅êㄟ汜瞽沆矬疳蝮弪┅┅ㄤ彐躅汜瞽沆矬疳蝮弪ㄩ蟓蜷玷舡骒犷腴铉溴扉黹翦颦蝓邯疳蝮弪┅ㄤ彐躅攮汜瞽沆矬疳蝮弪ㄡ钿ㄩ蟓蜷玷舡骒犷腴铉溴扉黹翦颦蝓哼疳蝮弪矧铒ㄩ蟓戾骠骒犷腴铉溴扉黹翦颦蝓哼疳蝮弪┅ㄩ蟓戾骠骒犷腴铉溴扉黹翦颦蝓哼疳蝮弪烘镬祜麇洵怡瘐钽趱狒轱舂┅换溴扉黹翦蝓韵南ㄤ彐躅轶戾骠骒犷腴铉溴扉黹翦颦蝓豉疱疳蝮弪脲骘祆秣邃怡瘐钽趱狒轱瞟坻镬祜麇洵怡瘐钽趱狒轱钶í骘祆秣邃怡瘐钽趱狒轱铋骘祆秣邃怡犷汨狎徙翦戾è戾ㄧ弭溴扉黹翦颦蝓瞽戾铉翳豉疱疳蝮弪┅ㄡ钿铒ㄦ镬祜麇洵怡躅殂镤瀛麒轸弩疳沐戾疳蝮弪┅ū矧铒ㄦ镬祜麇洵怡瘐钽趱狒轱瞽汨狎徙翦戾疳蝮弪┅ú岍ㄡ钿ㄦ镬祜麇洵怡瘐钽趱狒轱瞽汨狎徙翦戾疳蝮弪ú猢矧痱邈邃邃怡躅殂镤瀛麒轸弩疳沐疳蝮弪痱邈邃邃怡瘐钽趱狒轱瞽汨狎徙翦疳蝮弪┅┅矧铛祆骘祆秣邃怡瘐钽趱狒轱瞟骘镳糸镱íㄦ镬祜麇洵怡瘐钽趱狒轱瞽汨狎徙翦戾疳蝮弪┅┅ㄤ彐躅轶蜷玷舡骒犷腴铉溴扉黹翦颦蝓豉疱疳蝮弪脲痱邈邃邃怡瘐钽趱狒轱瞟垧蝈沐溴洵怡瘐钽趱狒轱钶痱邈邃邃怡瘐钽趱狒轱铋痱邈邃邃怡犷汨狎徙翦戾è戾ㄧ弭溴扉黹翦颦蝓瞽戾铉翳豉疱疳蝮弪┅ㄡ钿铒痱邈邃邃怡躅殂镤瀛麒轸弩疳沐疳蝮弪┅ū矧铒痱邈邃邃怡瘐钽趱狒轱瞽汨狎徙翦疳蝮弪┅ú岍ㄡ钿痱邈邃邃怡瘐钽趱狒轱瞽汨狎徙翦疳蝮弪ú猢矧ㄦ镬祜麇洵怡躅殂镤瀛麒轸弩疳沐戾疳蝮弪ㄦ镬祜麇洵怡瘐钽趱狒轱瞽汨狎徙翦戾疳蝮弪┅┅矧铛祆痱邈邃邃怡瘐钽趱狒轱瞟骘镳糸镱í痱邈邃邃怡瘐钽趱狒轱瞽汨狎徙翦疳蝮弪┅┅ㄤ彐躅痱邈邃邃怡躅殂镤瀛麒轸弩疳沐疳蝮弪戾è汨狎疱咫疳蝮弪暴┅矧铛祆汨狎翳忮玳铑轭犷翳孱镦翳扉铄泔躅狍疹殂镤麒轸弩疳沐ㄦ轭汨狎躅殂镤瀛麒轸弩疳沐螵┅┅ㄤ彐躅骘祆秣邃怡躅殂镤瀛麒轸弩疳沐戾疳蝮弪戾è汨狎疱咫疳蝮弪戾瞟┅矧铛祆汨狎翳忮玳铑轭犷翳孱镦翳扉铄泔躅狍疹殂镤麒轸弩疳沐ㄦ轭汨狎躅殂镤瀛麒轸弩疳沐螵┅┅ㄤ彐躅痱邈邃邃怡瘐钽趱狒轱瞽汨狎徙翦疳蝮弪ㄦ轭疱咫疳蝮弪暴瘐钽趱狒轱铙┅ㄤ彐躅骘祆秣邃怡瘐钽趱狒轱瞽汨狎徙翦戾疳蝮弪ㄦ轭疱咫疳蝮弪戾瞟瘐钽趱狒轱铙┅换痱镢弩屙痂狍轶ㄤ彐躅痱镢弩蟓屙痂狍轶疳蝮弪戾è溴扉眢ㄩ瓠篝徙疳蝮弪┅镦骟弭癌篝徙铋飑祜镳烘矧溴扉黹翦横泸矬溴扉眢轰ㄣ镱è铒矧ㄥㄤ飙豉疱溴扉黹翦颟邯ㄥㄤ飙豉疱溴扉黹翦颟哼┅轰锃铒翳轭绌è犷铛祆篝徙氅铒ㄤ飙镳孱溴扉黹翦颟ㄤ飙沆矬溴扉黹翦颟轰锃铒翳轭绌è犷ㄤ飙沆矬溴扉黹翦颟ㄦ轭洵镳孱弪溴扉黹翦篝徙氅箬殒舡痫箝糸镱溴扉黹翦镦骟弭眭祠轲戾鲠祯瀛忾钿铄鳝篝徙铄鳝镦骟弭ㄣ祜箦屙痂狍轶疳蝮弪溴扉黹翦篝徙镦骟弭箦翩篝徙铄鳝篝徙氅箦翩镦骟弭铄鳝镦骟弭┅è潇镳孱溴扉黹翦颟箬殒舡痫箝糸镱溴扉黹翦镦骟弭瘐箬溴扉黹翦篝徙氅è潇沆矬溴扉黹翦颟轰锃铒翳轭绌ㄥ蝌矧⒃傩藕连闲盼连锰嫌藕连磐性倏立ㄤ飙豉疱溴扉黹翦颟ㄤ飙镳孱溴扉黹翦颟ㄤ飙沆矬溴扉黹翦颟铛祆篝徙氅┅┅┅ㄤ彐躅骈钿镳孱弪ㄤ屐轫轸弪篝徙氅戾è豉疱ㄤ飙豉疱溴扉黹翦颟┅灬忮祗è骈钿镳孱弪豉疱篝徙氅麒孱篝徙ㄩㄡ钿ㄥㄤ飙豉疱ㄣ狎篝徙氅豉疱ㄤ飙镳孱ㄣ狎篝徙氅┅鲠祯弩ㄣ狎篝徙氅ㄣ潋篝徙氅ㄦ轭洵镳孱弪豉疱ㄣ潋篝徙氅┅┅ㄦ轭洵镳孱弪豉疱篝徙氅┅ㄤ彐躅沆矬瀛屙痂狍轶疳蝮弪沆矬弪篝徙镦骟弭眭祠轲戾鲠祯瀛忾钿镳孱弪蝈篝ㄦ轭洵镳孱弪沆矬弪篝徙氅ㄣ镱è铛祆镳孱弪鲠祯弩ㄩㄤ飙镳孱沆矬弪ㄣ镱沆矬弪篝徙氅篝徙氅镦骟弭┅èㄤ飙铛镳孱弪ㄤ飙铛沆矬弪┅戾舄è戾ㄤ飙铛镳孱弪┅铄鳝镦骟弭ǐ镦骟弭ㄤ屐轫轸弪蝓瞽爵徵疳蝮弪镳孱弪沆矬弪戾瞟┅铄鳝沆矬弪磲脲溴扉黹翦呼疱ㄤ飙豉疱沆矬弪后翎螋ǐㄤ飙篝狎沆矬弪戾镦骟弭侯蹴ōㄤ飙铛沆矬弪戾瞟猴疱ㄤ飙镳孱沆矬弪恒祜箦ㄤ飙沆矬沆矬弪┅┅ㄣ祜箦屙痂狍轶疳蝮弪铄鳝沆矬弪蝈篝铄鳝镦骟弭┅èㄤ飙铛镳孱弪ㄤ飙铛沆矬弪┅戾舄è戾ㄤ飙铛沆矬弪┅铄鳝镦骟弭ǐ镦骟弭ㄤ屐轫轸弪蝓瞽爵徵疳蝮弪镳孱弪沆矬弪戾瞟┅鲠祯弩蝈篝铄鳝镦骟弭┅èㄤ飙铛镳孱弪ㄤ飙铛沆矬弪┅戾舄è戾ㄤ飙铛沆矬弪┅铄鳝镦骟弭ǐ镦骟弭ㄤ屐轫轸弪蝓瞽爵徵疳蝮弪镳孱弪沆矬弪戾瞟┅铄鳝镳孱弪磲脲溴扉黹翦呼疱ㄤ飙豉疱镳孱弪后翎螋ㄤ飙篝狎镳孱弪侯蹴ōㄤ飙铛镳孱弪戾瞟猴疱ㄤ飙镳孱镳孱弪恒祜箦ㄤ飙沆矬镳孱弪┅┅鲠祯弩ㄣ镱铄鳝镳孱弪蝈篝铄鳝镦骟弭┅ㄥ蝌矧⒚滔优液连闲盼乓立沆矬弪镳孱弪┅┅换ㄤ彐躅溴扉黹翦颦蝓瞽爵徵疳蝮弪镳孱弪沆矬弪戾瞟戾è镳孱痫ǐㄤ飙篝狎镳孱弪ōㄤ飙铛镳孱弪戾瞟┅ㄣ祜箦痫ㄤ飙篝狎沆矬弪┅眭祠轲戾鲠祯瀛忾钿篝蝻铉铛屙铛愆ㄦ祜矧戾博戾舄è镳孱翎ㄦ矧磲铋窿窿祜镳候屦遽篝蝻铉铛恒镬戾泗⒓篝蝻铉劲祜镳候屦遽屙铛恒镬戾泗⒓屙劲┅ㄣ祜箦翎ㄦ矧磲铋窿窿祜镳候屦遽屙铛恒镬戾泗⒓屙劲祜镳候屦遽篝蝻铉铛恒镬戾泗⒓篝蝻铉劲┅铄鳝镦骟弭癌韵南秕麴豸蝈痨徙濠翎蝈痨徙瀛篝蜷铉疳蝮弪镳孱翎镳孱痫ǐ镳孱痫戾瞟ㄩ钽铄鳝镦骟弭ō戾铉翳镳孱翎绌戾瞟蝈痨徙瀛篝蜷铉疳蝮弪沆矬瀛翎ǐ沆矬瀛痫铄鳝镦骟弭ǐ沆矬瀛痫戾铄鳝镦骟弭┅ㄩ钽铄鳝镦骟弭ō戾铉翳沆矬瀛翎绌戾瞟蝈趱蝾铄镦骟弭铄鳝镦骟弭┅┅